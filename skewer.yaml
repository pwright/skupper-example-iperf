title: iPerf
subtitle: Perform real-time network throughput measurements while using iPerf3
overview: |
  This tutorial demonstrates how to perform real-time network throughput measurements across Kubernetes 
  using the iperf3 tool.
  In this tutorial you:
  * deploy iperf3 in two separate clusters
  * run iperf3 client test instances
prerequisites: |
  * The `kubectl` command-line tool, version 1.15 or later
  ([installation guide][install-kubectl])
  
  * Access to two clusters to observe performance. 
  As an example, the two clusters might consist of:
  
  * A private cloud cluster running on your local machine (**east**)
  * A public cloud cluster running in a public cloud provider (**west**)
sites:
  west:
    platform: kubernetes
    namespace: west
    env:
      KUBECONFIG: ~/.kube/config-west
  east:
    platform: kubernetes
    namespace: east
    env:
      KUBECONFIG: ~/.kube/config-east
steps:
  - standard: platform/access_your_kubernetes_clusters
  - standard: platform/create_your_kubernetes_namespaces
  - standard: platform/install_skupper_on_your_kubernetes_clusters
  - standard: platform/install_the_skupper_command_line_tool
  - standard: skupper/create_your_sites/kubernetes_cli
  - standard: skupper/link_your_sites/kubernetes_cli
    commands:
      west:
        - run: skupper token issue ~/east-to-west.token
      east:
        - run: skupper token redeem ~/east-to-west.token
  - title: Deploy the iperf3 servers
    preamble: |
      After creating the application router network, deploy `iperf3` in each namespace.
    commands:
      east:
        - run: kubectl apply -f deployment-iperf3-a.yaml
      west:
        - run: kubectl apply -f deployment-iperf3-b.yaml
  - title: Create connectors for the iperf3 servers
    preamble: |
      With Skupper v2, connectors run in the namespace where the workload is deployed.
      Create a connector for each iperf3 server so the application network can reach the pods.
    commands:
      east:
        - await_resource: deployment/iperf3-server-a
        - run: skupper connector create iperf3-server-a 5201 --workload deployment/iperf3-server-a 
      west:
        - await_resource: deployment/iperf3-server-b
        - run: skupper connector create iperf3-server-b 5201 --workload deployment/iperf3-server-b 
  - title: Create listeners for the iperf3 services
    preamble: |
      Listeners create service endpoints in each namespace so clients can reach those connectors.
      Configure listeners for every iperf3 service in each namespace.
    commands:
      east:
        - run: skupper listener create iperf3-server-a 5201
        - run: skupper listener create iperf3-server-b 5201
      west:
        - run: skupper listener create iperf3-server-a 5201
        - run: skupper listener create iperf3-server-b 5201
  - title: Run benchmark tests across the clusters
    preamble: |
      After deploying the iperf3 servers into the private and public cloud clusters,
      the virtual application network enables communications even though they are 
      running in separate clusters.
    commands:
      east:
        - run: kubectl exec $(kubectl get pod -l application=iperf3-server-a -o=jsonpath='{.items[0].metadata.name}') -- iperf3 -c iperf3-server-a > results/east-to-a.log
        - run: kubectl exec $(kubectl get pod -l application=iperf3-server-a -o=jsonpath='{.items[0].metadata.name}') -- iperf3 -c iperf3-server-b > results/east-to-b.log
      west:
        - run: kubectl exec $(kubectl get pod -l application=iperf3-server-b -o=jsonpath='{.items[0].metadata.name}') -- iperf3 -c iperf3-server-a > results/west-to-a.log
        - run: kubectl exec $(kubectl get pod -l application=iperf3-server-b -o=jsonpath='{.items[0].metadata.name}') -- iperf3 -c iperf3-server-b > results/west-to-b.log
        - run: skupper debug dump
  - standard: skupper/cleaning_up/kubernetes_cli
    commands:
      east:
        - run: kubectl delete deployment iperf3-server-a
        - run: skupper delete
      west:
        - run: kubectl delete deployment iperf3-server-b
        - run: skupper delete
next_steps: |
  - [Find more examples](https://skupper.io/examples/)
